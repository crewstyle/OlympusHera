/*!
 * hera.upload.js v2.0.0
 * https://github.com/crewstyle/OlympusHera
 *
 * This plugin make the WordPress medialib popin usable in all backoffice pages.
 *
 * Example of JS:
 *      $('.upload').heraUpload({
 *          addbutton: '.add-media',                    //add media button
 *          color: '#ffaaaa',                           //background color used when deleting a media
 *          container: '.container',                    //node element of main container
 *          delallbutton: '.del-all-medias',            //delete all medias button
 *          delbutton: '.del-media',                    //delete media button
 *          items: 'fieldset',                          //node elements of items
 *          source: '#template-id',                     //node script element in DOM containing handlebars JS temlpate
 *
 *          //Options usefull for WordPress medialib
 *          media: null,                                //media WordPress object used to open modal
 *          multiple: false,                            //define if user can have multiple selection in modal
 *          //target: null,                               //
 *          title: false,                               //title of the media popin
 *          type: 'image',                              //define the kind of items to display in modal
 *          wpid: null,                                 //contains Wordpress textarea ID
 *      });
 *
 * Example of HTML:
 *      --
 *
 * Copyright 2016 Achraf Chouk
 * Achraf Chouk (https://github.com/crewstyle)
 */
!function(a){"use strict";var b=function(a,b){var c=this;wp&&wp.media&&(c.$el=a,c.options=b,c.init())};b.prototype.$el=null,b.prototype.media=null,b.prototype.options=null,b.prototype.selections=null,b.prototype.source=null,b.prototype.init=function(){var b=this;b.options.wpid=wp.media.model.settings.post.id,b.source=a(b.options.source).html(),b.$el.find(b.options.addbutton).on("click",a.proxy(b.open_medialib,b)),b.$el.find(b.options.delbutton).on("click",a.proxy(b.remove_media,b)),b.$el.find(b.options.delallbutton).on("click",a.proxy(b.remove_all,b))},b.prototype.open_medialib=function(a){a.preventDefault();var b=this;return b.media?(b.opened_medialib(),void b.media.open()):(b.media=wp.media.frames.file_frame=wp.media({library:{type:b.options.type},multiple:b.options.multiple,title:b.options.title}),b.opened_medialib(),b.media.on("select",function(){b.selections=b.media.state().get("selection"),b._attach_items(b.selections.toJSON()),wp.media.model.settings.post.id=b.options.wpid}),void b.media.open())},b.prototype.opened_medialib=function(b){var c=this;c.media.on("open",function(){var b=c.$el.find(c.options.items);b.length&&(c.selections=c.media.state().get("selection"),a.each(b,function(){var b=a(this).attr("data-u"),d=wp.media.attachment(b);d.fetch(),c.selections.add(d?[d]:[])}))})},b.prototype.remove_all=function(a){a.preventDefault();var b=this;b.$el.find(b.options.delbutton).click()},b.prototype.remove_media=function(b){b.preventDefault();var c=this,d=a(b.target||b.currentTarget),e=d.closest(c.options.items);e.css("background",c.options.color),e.stop().animate({opacity:"0"},"slow",function(){e.remove()})},b.prototype._attach_items=function(b){var c=this;if(b.length){var d=c.$el.find(c.options.container);a.each(b,function(b,e){if(!d.find(c.options.items+'[data-u="'+e.id+'"]').length){c.options.multiple||c.$el.find(c.options.delbutton).click();var f={alt:e.alt,caption:e.caption,display:"image"!=c.options.type?e.icon:e.sizes.thumbnail?e.sizes.thumbnail.url:e.url,icon:e.icon,height:e.height,id:e.id,name:e.name,sizes:[],url:e.url,width:e.width};a.each(e.sizes,function(a,b){f.sizes.push({height:b.height,id:e.id,key:a,name:b.name,url:b.url,width:b.width})});var g=Handlebars.compile(c.source),h=g(f);d.append(h);var i=d.find(c.options.items).last();i.find(".olz-tooltip").heraTooltip(),i.find(c.options.delbutton).on("click",a.proxy(c.remove_media,c))}})}};var c={init:function(c){if(!this.length)return!1;var d={addbutton:".add-media",color:"#ffaaaa",container:".container",delallbutton:".del-all-medias",delbutton:".del-media",items:"fieldset",source:"#template-id",media:null,multiple:!1,title:!1,type:"image",wpid:null};return this.each(function(){c&&a.extend(d,c),new b(a(this),d)})},update:function(){},destroy:function(){}};a.fn.heraUpload=function(b){return c[b]?c[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?(a.error("Method "+b+" does not exist on heraUpload"),!1):c.init.apply(this,arguments)}}(window.jQuery);